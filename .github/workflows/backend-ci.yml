name: Backend CI/CD

on:
  push:
    branches: [main, staging]
    paths:
      - 'packages/backend/**'
      - 'amplify/**'
      - 'amplify.yml'
      - 'package.json'
      - 'yarn.lock'
  workflow_dispatch:

jobs:
  wait-for-checks:
    name: Wait for Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Wait for lint workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Lint Backend
          ref: ${{ github.sha }}
          timeoutSeconds: 300
          intervalSeconds: 10

      - name: Wait for type-check workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Type Check Backend
          ref: ${{ github.sha }}
          timeoutSeconds: 300
          intervalSeconds: 10

  detect-changes:
    name: Detect Backend Changes
    runs-on: ubuntu-latest
    needs: wait-for-checks
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for backend changes
        id: changes
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -qE '^(packages/backend/|amplify/|amplify\.yml|package\.json|yarn\.lock)'; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

  backend-deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend_changed == 'true' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ca-central-1

      - name: Deploy Amplify backend
        run: |
          aws amplify start-job \
            --app-id ${{ secrets.AMPLIFY_BACKEND_APP_ID }} \
            --branch-name ${{ github.ref_name }} \
            --job-type RELEASE

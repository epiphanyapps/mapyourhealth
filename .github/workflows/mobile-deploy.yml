name: Mobile Web Deploy

on:
  push:
    branches: [main, staging]
    paths:
      - 'apps/mobile/**'
      - 'amplify.yml'
      - 'package.json'
      - 'yarn.lock'
  workflow_run:
    workflows: ["Backend CI/CD"]
    types: [completed]
    branches: [main, staging]

jobs:
  wait-for-checks:
    name: Wait for Lint and Type Check
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Wait for lint workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Lint Mobile
          ref: ${{ github.event_name == 'push' && github.sha || github.event.workflow_run.head_sha }}
          timeoutSeconds: 300
          intervalSeconds: 10

      - name: Wait for type-check workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Type Check Mobile
          ref: ${{ github.event_name == 'push' && github.sha || github.event.workflow_run.head_sha }}
          timeoutSeconds: 300
          intervalSeconds: 10

  deploy-mobile:
    name: Deploy Mobile Web
    runs-on: ubuntu-latest
    needs: wait-for-checks
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Trigger Amplify Build
        run: |
          echo "Triggering Amplify build for mobile web..."
          HTTP_CODE=$(curl -s -X POST "${{ secrets.AMPLIFY_MOBILE_WEBHOOK_URL }}&operation=startbuild" \
            -H "Content-Type: application/json" \
            -w "%{http_code}" \
            -o /tmp/webhook_response.json)

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "✅ Amplify build triggered successfully (HTTP $HTTP_CODE)"
            cat /tmp/webhook_response.json
          else
            echo "❌ Failed to trigger Amplify build (HTTP $HTTP_CODE)"
            cat /tmp/webhook_response.json
            exit 1
          fi

      - name: Wait for Amplify Build
        run: |
          echo "Waiting for Amplify build to complete..."
          sleep 30  # Initial wait

          # Poll for build status (optional - can be removed if you don't need to wait)
          for i in {1..60}; do
            echo "Checking build status... attempt $i"
            sleep 30
          done
        continue-on-error: true

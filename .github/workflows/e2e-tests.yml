name: E2E Tests

on:
  # pull_request: # Disabled for now - too slow for PR feedback loop
  #   branches: [main]
  #   paths:
  #     - 'apps/mobile/**'
  #     - '.github/workflows/e2e-tests.yml'
  push:
    branches: [main]
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  e2e-tests:
    name: Run E2E Tests (iOS Simulator) 
    runs-on: [self-hosted, macOS]
    timeout-minutes: 30  # Reduced from 45 - fail faster if hanging
    env:
      MAESTRO_APP_ID: com.epiphanyapps.mapyourhealth
      JAVA_HOME: /usr/local/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
      MAESTRO_DRIVER_STARTUP_TIMEOUT: 120000
    steps:
      - name: Set up Java in PATH
        run: echo "/usr/local/opt/openjdk@17/bin" >> $GITHUB_PATH

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Create Amplify outputs stub for CI build
        run: |
          STUB='{"version":"1","auth":{"aws_region":"us-east-1","user_pool_id":"us-east-1_test","user_pool_client_id":"test","identity_pool_id":"us-east-1:test"},"data":{"url":"https://test.appsync-api.us-east-1.amazonaws.com/graphql","aws_region":"us-east-1","default_authorization_type":"API_KEY","api_key":"da2-test"}}'
          echo "$STUB" > apps/mobile/amplify_outputs.json

      - name: Install CocoaPods dependencies
        run: |
          cd apps/mobile/ios 2>/dev/null && pod install --repo-update || echo "Pods will be installed during prebuild"

      - name: Generate native project & build for iOS Simulator
        working-directory: apps/mobile
        run: |
          npx expo prebuild --platform ios --clean
          cd ios
          pod install --repo-update

      - name: Build iOS app for simulator
        working-directory: apps/mobile/ios
        run: |
          # Determine the .xcworkspace name
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          SCHEME=$(echo "$WORKSPACE" | sed 's/.xcworkspace//')

          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            CODE_SIGNING_ALLOWED=NO \
            | xcbeautify || xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            CODE_SIGNING_ALLOWED=NO

      - name: Boot iOS Simulator
        run: |
          # Find an available iPhone 16 simulator (or fall back to any iPhone)
          DEVICE_ID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data['devices'].items():
              for d in devices:
                  if 'iPhone 16' in d['name'] and d['isAvailable']:
                      print(d['udid'])
                      sys.exit(0)
          # fallback: any available iPhone
          for runtime, devices in data['devices'].items():
              for d in devices:
                  if 'iPhone' in d['name'] and d['isAvailable']:
                      print(d['udid'])
                      sys.exit(0)
          sys.exit(1)
          ")

          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" 2>/dev/null || true
          echo "SIMULATOR_UDID=$DEVICE_ID" >> $GITHUB_ENV

      - name: Install app on simulator
        run: |
          # Find the .app bundle from DerivedData
          APP_PATH=$(find apps/mobile/ios/build/Build/Products/Debug-iphonesimulator -name "*.app" -type d | head -1)
          echo "Installing: $APP_PATH"
          xcrun simctl install "$SIMULATOR_UDID" "$APP_PATH"

      - name: Install Maestro
        run: |
          if ! command -v maestro &>/dev/null && [ ! -f "$HOME/.maestro/bin/maestro" ]; then
            curl -Ls "https://get.maestro.mobile.dev" | bash
          fi
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Run E2E tests
        run: |
          # Launch the app
          xcrun simctl launch "$SIMULATOR_UDID" "$MAESTRO_APP_ID"
          sleep 10

          # Run Maestro flows
          $HOME/.maestro/bin/maestro test apps/mobile/.maestro/flows \
            --env MAESTRO_APP_ID="$MAESTRO_APP_ID"

      - name: Shutdown simulator
        if: always()
        run: xcrun simctl shutdown "$SIMULATOR_UDID" 2>/dev/null || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results
          path: ~/.maestro/tests
          retention-days: 7
          if-no-files-found: ignore

      # PR comments disabled - E2E no longer runs on PRs for performance
      # - name: Comment on PR with results
      #   if: github.event_name == 'pull_request' && always()
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const status = '${{ job.status }}' === 'success' ? ':white_check_mark:' : ':x:';
      #       const body = `## E2E Test Results ${status}
      #       **Platform:** iOS (Simulator)
      #       **Status:** ${{ job.status }}
      #       **Commit:** ${{ github.sha }}
      #       Download test artifacts for detailed results.`;
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: body
      #       });

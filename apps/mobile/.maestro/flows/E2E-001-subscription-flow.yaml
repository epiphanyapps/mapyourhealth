# flow: E2E-001 Subscription and Notification Flow
# intent:
#   Test the complete guest-to-subscriber journey:
#   1. Guest sees empty state with search prompt
#   2. Guest can search for cities and view data
#   3. Follow button triggers auth gate
#   4. User can navigate to signup
#
# NOTE: This flow tests up to the auth gate. Full signup requires
# email confirmation which cannot be automated in Maestro.

appId: ${MAESTRO_APP_ID}
---

# Launch app with clean state
- launchApp:
    clearState: true

# Wait for app to load
- waitForAnimationToEnd:
    timeout: 5000

# ========================================
# Part 1: Guest Empty State
# ========================================
# Verify empty state is shown for guests
- assertVisible:
    text: "Find out how safe your location is"
    label: "Guest empty state title is visible"

- assertVisible:
    text: "Search above to get safety insights"
    optional: true

# Verify search bar is visible
- assertVisible:
    text: "Search city or location..."
    label: "Search bar is visible"

# ========================================
# Part 2: Search for a City (New York)
# ========================================
- tapOn:
    text: "Search city or location..."
    label: "Tap on search bar"

- inputText: "New York"

# Wait for autocomplete suggestions to appear
- waitForAnimationToEnd:
    timeout: 3000

# Tap on the first suggestion (New York, NY)
# Use index: 1 to skip the search field text and tap the dropdown
- tapOn:
    text: ".*New York.*"
    index: 1
    label: "Select New York from autocomplete"

# Wait for location data to load
- waitForAnimationToEnd:
    timeout: 5000

# Wait for New York data to appear
- extendedWaitUntil:
    visible: ".*New York.*"
    timeout: 10000

# Verify we navigated to the location with data
- assertVisible:
    text: ".*New York.*"
    label: "Location is visible"

# Verify category cards are visible (any of: Water, Air, Health, Disaster)
- assertVisible:
    text: "Water.*"
    optional: true

# ========================================
# Part 3: Follow Button Triggers Auth Gate (on New York)
# ========================================
# Test Follow button on New York since it has data.
# Los Angeles doesn't have data in test DB (shows "Notify Me" instead).
- tapOn:
    text: ".*Follow.*"
    label: "Tap Follow button (should trigger auth gate)"

# Verify auth gate appears (Login screen)
- assertVisible:
    text: "Welcome Back"
    label: "Login screen is visible"

- assertVisible:
    text: "Sign In"
    label: "Sign In button is visible"

# ========================================
# Part 4: Navigate to Signup
# ========================================
- tapOn:
    text: ".*Sign up"
    label: "Navigate to signup screen"

- assertVisible:
    text: "Create Account"
    label: "Signup screen is visible"

- assertVisible:
    text: "Sign Up"
    label: "Sign Up button is visible"

# ========================================
# Part 5: Go Back to Dashboard (via back navigation)
# ========================================
- tapOn:
    id: "back"
    optional: true

- tapOn:
    id: "back"
    optional: true

# Verify we can get back to dashboard with New York still showing
- runFlow:
    when:
      visible: "Search city or location..."
    commands:
      - assertVisible:
          text: ".*New York.*"
          optional: true

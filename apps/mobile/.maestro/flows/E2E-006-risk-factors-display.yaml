# flow: E2E-006 Risk Factors Display (Only Warning/Danger Stats)
# intent:
#   Verify that only risk factors (warning/danger stats) are displayed on
#   category detail screens, and safe stats are hidden:
#   1. Search for a location with known risks
#   2. Navigate to Tap Water Quality category
#   3. Verify risk contaminants are visible
#   4. Navigate to a category with no risks
#   5. Verify "No risks detected" message appears

appId: ${MAESTRO_APP_ID}
onFlowStart:
  - runFlow: ../shared/_OnFlowStart.yaml
---

# ========================================
# Part 1: Search for a Location
# ========================================
- assertVisible:
    text: "Search city or.*"
    label: "Search bar is visible"

- tapOn:
    text: "Search city or.*"
    label: "Tap on search bar"

- inputText: "New York"
- pressKey: Enter
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "New York"
    timeout: 10000

# ========================================
# Part 2: Navigate to Tap Water Quality Category
# ========================================
- tapOn:
    text: "Tap Water.*"
    label: "Tap Tap Water Quality category"

- waitForAnimationToEnd

# Verify category detail screen header is visible
- assertVisible:
    text: "Tap Water Quality"
    label: "Tap Water Quality detail screen is visible"

# ========================================
# Part 3: Verify Risk Factors Are Displayed or No Risks Message
# ========================================
# Either risk contaminants should be visible OR "No risks detected" message
# Using conditional checks - at least one must be true

- runFlow:
    when:
      visible: "No risks detected for this category"
    commands:
      - assertVisible:
          text: "No risks detected for this category"
          label: "No risks message displayed when location has no water quality issues"

# If there are risks, they should have status indicators
- runFlow:
    when:
      notVisible: "No risks detected for this category"
    commands:
      # Verify we see contaminant data (table headers or stat items)
      - assertVisible:
          text: "(WHO|LOCAL|Value|ppm|ppb|pCi/L)"
          optional: true
          label: "Contaminant data is displayed"

# ========================================
# Part 4: Navigate Back to Dashboard
# ========================================
- tapOn:
    id: ".*back.*"
    label: "Tap back button"

- waitForAnimationToEnd

# Verify we're back on dashboard
- assertVisible:
    text: "New York"
    label: "Back on dashboard with zip code visible"

# ========================================
# Part 5: Check Another Category (Air Pollution)
# ========================================
# Tap Air Pollution - it has sub-categories so should expand first
- tapOn:
    text: "Air Pollut.*"
    label: "Tap Air Pollution category"

- waitForAnimationToEnd

# Check if we see Radon sub-category (accordion behavior)
- runFlow:
    when:
      visible: "Radon"
    commands:
      - tapOn:
          text: "Radon"
          label: "Tap Radon sub-category"
      - waitForAnimationToEnd

# Verify Air Pollution detail screen
- assertVisible:
    text: "Air Pollution"
    label: "Air Pollution detail screen is visible"

# ========================================
# Part 6: Verify Risk Logic on Air Pollution
# ========================================
# Either risk data or "No risks detected" should appear
- runFlow:
    when:
      visible: "No risks detected for this category"
    commands:
      - assertVisible:
          text: "No risks detected for this category"
          label: "No risks message for Air Pollution"

- runFlow:
    when:
      notVisible: "No risks detected for this category"
    commands:
      # Should see radon data or other air quality metrics
      - assertVisible:
          text: "(Radon|pCi/L|AQI)"
          optional: true
          label: "Air pollution risk data visible"

# Navigate back
- tapOn:
    id: ".*back.*"
    label: "Tap back button"

- waitForAnimationToEnd

# ========================================
# Part 7: Check Pathogens Category
# ========================================
- tapOn:
    text: "Pathogen.*"
    label: "Tap Pathogens category"

- waitForAnimationToEnd

# Check if we see Lyme Disease sub-category (accordion behavior)
- runFlow:
    when:
      visible: "Lyme Disease"
    commands:
      - tapOn:
          text: "Lyme Disease"
          label: "Tap Lyme Disease sub-category"
      - waitForAnimationToEnd

# Verify Pathogens detail screen
- assertVisible:
    text: "Pathogens"
    label: "Pathogens detail screen is visible"

# Either risks or no risks message
- runFlow:
    when:
      visible: "No risks detected for this category"
    commands:
      - assertVisible:
          text: "No risks detected for this category"
          label: "No risks message for Pathogens"

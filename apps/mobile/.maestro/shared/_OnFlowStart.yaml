# flow: Shared _OnFlowStart
# intent:
#   Launch the app and handle Expo dev client screens automatically.
#   Works with both development builds (has dev client) and preview builds (no dev client).
#
# Usage:
#   appId: ${MAESTRO_APP_ID}
#   onFlowStart:
#     - runFlow: ../shared/_OnFlowStart.yaml
#   ---
#   [your maestro flow]
#
# For reliable E2E testing, use a preview build:
#   eas build --profile e2e --platform ios --local
#
appId: ${MAESTRO_APP_ID}
---

# Launch app with clean state
- launchApp:
    clearState: true
    clearKeychain: true
    stopApp: true

# Initial wait for app to start
- waitForAnimationToEnd:
    timeout: 5000

# Handle Expo dev client: Development servers picker
# This appears when app needs to connect to Metro bundler
- runFlow:
    when:
      visible: 'Development servers'
    commands:
      - tapOn:
          text: "http://.*:.*"
          retryTapIfNoChange: false
      # Wait for Metro to bundle and load the app (can take 10-30s)
      - waitForAnimationToEnd:
          timeout: 30000

# Handle Expo dev client: Close button on bottom sheet
- runFlow:
    when:
      visible: 'Close'
    commands:
      - tapOn: "Close"
      - waitForAnimationToEnd:
          timeout: 3000

# Handle Expo dev client: Developer menu tutorial ("Continue" button)
- runFlow:
    when:
      visible: 'Continue'
    commands:
      - tapOn: "Continue"
      - waitForAnimationToEnd:
          timeout: 3000

# Handle Expo dev client: Developer tools menu (dismiss with back)
- runFlow:
    when:
      visible: 'Go home'
    commands:
      - back
      - waitForAnimationToEnd:
          timeout: 3000

# Final wait to ensure app is fully loaded and stable
- waitForAnimationToEnd:
    timeout: 5000
